<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-15">
<title>Snow Profile</title>
</head>

<body>
<h1>Snow Profile</h1>
<div id="snow_profile_diagram"></div>
<script src="kinetic-v4.7.2.min.js"></script>
<script defer="defer">
  /**
   * Vertical height in pixels of the hardness (horizontal) axis label.
   * @const
   */
  var HARD_LABEL_HT = 40;

  /**
   * Horizontal width in pixels of the depth (vertical) axis label.
   * @const
   */
  var DEPTH_LABEL_WD = 40;

  /**
   * Width in pixels available for plotting data.
   * @const
   */
  var GRAPH_WIDTH = 500;

  /**
   * Height in pixels available for plotting data.
   * @const
   */
  var GRAPH_HEIGHT = 500;

  /**
   * Size in pixels of the handle square
   * @const
   */
  var HANDLE_SIZE = 7;

  /**
   * Width in pixels of the right sidebar
   * const
   */
  var RIGHT_SIDE_WD = 100;

  /**
   * Color of the labels and axis lines
   * @const
   */
  var LABEL_COLOR = '#003390';

  /**
   * Color of the chart background grid
   * @const
   */
  var GRID_COLOR = '#69768C';

  /**
   * Central x of the data plotting area.
   * @const
   */
  var GRAPH_CENTER_X = DEPTH_LABEL_WD + 1 + (GRAPH_WIDTH / 2);

  /**
   * Central y of the data plotting area
   * @const
   */
  var GRAPH_CENTER_Y = (GRAPH_HEIGHT / 2);

  /**
   * Maximum x value allowed for a handle (hardness 'I').
   * @const
   */
  var HANDLE_MAX_X = DEPTH_LABEL_WD + 1 + GRAPH_WIDTH - HANDLE_SIZE;

  /**
   * Minimum x value allowed for a handle (hardness 'F-').
   * @const
   */
  var HANDLE_MIN_X = DEPTH_LABEL_WD + 1;

  /**
   * Width in pixels of one hardness band in the CAAML_HARD table
   *
   * Calculation depends on knowing there are 21 entries in the table
   * @const
   */
  var HARD_BAND_WD = (GRAPH_WIDTH - HANDLE_SIZE) / 20;

  /**
   * Table of CAAML hardness values (HardnessBaseEnumType).
   *
   * CAAML_HARD[i][0] is the alpha string defined by CAAML 5.0.
   * CAAML_HARD[i][1] is a boolean; whether to draw a line here.
   * CAAML_HARD[i][2] minimum x value having this hardness.  The maximum x
   *   value for this hardness is one less than the minimum for the next row.
   * @const
   */
  var CAAML_HARD = [
    ['F-',    0, HANDLE_MIN_X],
    ['F',     1, HANDLE_MIN_X + HARD_BAND_WD * 0.5],
    ['F+',    0, HANDLE_MIN_X + HARD_BAND_WD * 1.5],
    ['F-4F',  0, HANDLE_MIN_X + HARD_BAND_WD * 2.5],
    ['4F-',   0, HANDLE_MIN_X + HARD_BAND_WD * 3.5],
    ['4F',    1, HANDLE_MIN_X + HARD_BAND_WD * 4.5],
    ['4F+',   0, HANDLE_MIN_X + HARD_BAND_WD * 5.5],
    ['4F-1F', 0, HANDLE_MIN_X + HARD_BAND_WD * 6.5],
    ['1F-',   0, HANDLE_MIN_X + HARD_BAND_WD * 7.5],
    ['1F',    1, HANDLE_MIN_X + HARD_BAND_WD * 8.5],
    ['1F+',   0, HANDLE_MIN_X + HARD_BAND_WD * 9.5],
    ['1F-P',  0, HANDLE_MIN_X + HARD_BAND_WD * 10.5],
    ['P-',    0, HANDLE_MIN_X + HARD_BAND_WD * 11.5],
    ['P',     1, HANDLE_MIN_X + HARD_BAND_WD * 12.5],
    ['P+',    0, HANDLE_MIN_X + HARD_BAND_WD * 13.5],
    ['P-K',   0, HANDLE_MIN_X + HARD_BAND_WD * 14.5],
    ['K-',    0, HANDLE_MIN_X + HARD_BAND_WD * 15.5],
    ['K',     1, HANDLE_MIN_X + HARD_BAND_WD * 16.5],
    ['K+',    0, HANDLE_MIN_X + HARD_BAND_WD * 17.5],
    ['K-I',   0, HANDLE_MIN_X + HARD_BAND_WD * 18.5],
    ['I',     1, HANDLE_MIN_X + HARD_BAND_WD * 19.5],
  ];

  /**
   * Vertical height in pixels of the KineticJS stage
   * @const
   */
  var STAGE_HT = GRAPH_HEIGHT + HARD_LABEL_HT + 1;

  /**
   * Horizontal width in pixels of the KineticJS stage
   * @const
   */
  var STAGE_WD = DEPTH_LABEL_WD + 1 + GRAPH_WIDTH + RIGHT_SIDE_WD;

  var stage = new Kinetic.Stage({
    container: 'snow_profile_diagram',
    width: STAGE_WD,
    height: STAGE_HT
  });

  var layer = new Kinetic.Layer();

  // Draw and label the depth (vertical) axis
  layer.add(new Kinetic.Line({
    points: [DEPTH_LABEL_WD, 0, DEPTH_LABEL_WD, GRAPH_HEIGHT + 1],
    stroke: LABEL_COLOR,
    strokeWidth: 1
  }));
  for (var j = 0; j < GRAPH_HEIGHT; j += 50) {
    layer.add(new Kinetic.Text({
      x: 10,
      y: j,
      text: j/2.5,
      fontSize: 12,
      fontStyle: 'bold',
      fontFamily: 'sans-serif',
      fill: LABEL_COLOR,
      align: 'right'
    }));
    if (j) {
      layer.add(new Kinetic.Line({
        points: [
          [DEPTH_LABEL_WD + 1, j + 1],
          [DEPTH_LABEL_WD + 1 + GRAPH_WIDTH, j]
        ],
        stroke: GRID_COLOR,
        strokeWidth: 1
      }));
    }
  }

  // Draw and label the hardness (horizontal) axis
  layer.add(new Kinetic.Line({
    points: [
      [DEPTH_LABEL_WD, GRAPH_HEIGHT + 1],
      [DEPTH_LABEL_WD + GRAPH_WIDTH, GRAPH_HEIGHT + 1]
    ],
    stroke: LABEL_COLOR,
    strokeWidth: 1
  }));

  // Iterate through the table of CAAML hardness codes to
  // build the hardness (horizontal) scale for the graph area
  for (var i = 0; i < CAAML_HARD.length; i++) {
    var x = DEPTH_LABEL_WD + 1 + (HARD_BAND_WD * i) + (HANDLE_SIZE / 2);
    if (CAAML_HARD[i][1]) {

      // Add a vertical line to show this hardness value
      layer.add(new Kinetic.Line({
        points: [
          [x, 0],
          [x, GRAPH_HEIGHT]
        ],
        stroke: GRID_COLOR,
        strokeWidth: 1
      }));
      layer.add(new Kinetic.Text({
        x: x,
        y: GRAPH_HEIGHT + 10,
        text: CAAML_HARD[i][0],
        fontSize: 12,
        fontStyle: 'bold',
        fontFamily: 'sans-serif',
        fill: LABEL_COLOR,
        align: 'center'
      }));
    };
  }
  var hardness_text = new Kinetic.Text({
    x: GRAPH_CENTER_X,
    y: STAGE_HT - 14,
    text: 'Hardness',
    fontSize: 18,
    fontStyle: 'bold',
    fontFamily: 'sans-serif',
    fill: LABEL_COLOR,
    align: 'center'
  });
  hardness_text.setOffsetX(hardness_text.getWidth() / 2 );
  layer.add(hardness_text);

  // Add a handle to control surface layer hardness.
  // This handle can only move horizontally
  var surf_handle = new Kinetic.Rect({
    x: GRAPH_CENTER_X,
    y: 0,
    width: HANDLE_SIZE,
    height: HANDLE_SIZE,
    fill: '#000',
    draggable: true,
    dragBoundFunc: function(pos) {
      var newX = pos.x;
      if (pos.x < HANDLE_MIN_X) {
        newX = HANDLE_MIN_X;
      }
      else if (pos.x > HANDLE_MAX_X) {
        newX = HANDLE_MAX_X;
      }
      return{
        x: newX,
        y: 0
      }
    }
  });

  // Style the cursor for the handle
  surf_handle.on('mouseover', function() {
    document.body.style.cursor = 'pointer';
    surf_handle_loc.setVisible(1);
    stage.draw();
  });
  surf_handle.on('mouseout', function() {
    document.body.style.cursor = 'default';
    surf_handle_loc.setVisible(0);
    stage.draw();
  });
  layer.add(surf_handle);

  // Add text to show current surface handle location.
  surf_handle_loc = new Kinetic.Text({
        x: DEPTH_LABEL_WD + 1 + GRAPH_WIDTH + 10,
        y: 0,
        fontSize: 12,
        fontStyle: 'bold',
        fontFamily: 'sans-serif',
        fill: LABEL_COLOR,
        align: 'left',
        visible: 0
  });
  layer.add(surf_handle_loc);

  // Add a line to show surface layer hardness
  var surf_line = new Kinetic.Line({
    points: [[DEPTH_LABEL_WD + 1, Math.floor(HANDLE_SIZE / 2)],
             [surf_handle.getX(), Math.floor(HANDLE_SIZE / 2)]],
    stroke: '#000'
  });
  layer.add(surf_line);
  surf_handle.on('dragmove', function() {
    surf_line.setPoints([DEPTH_LABEL_WD + 1, 3, surf_handle.getX(), 3]);
    var hard_code = 'I';
    for (var i = 0; i < CAAML_HARD.length - 1; i++) {
      if ((surf_handle.getX() >= (CAAML_HARD[i][2])
          && (surf_handle.getX() < (CAAML_HARD[i+1][2])))) {
        hard_code = CAAML_HARD[i][0];
        break;
      }
    }
    surf_handle_loc.setText( '(0,' + hard_code + ')');
  });

  // add the layer to the stage
  stage.add(layer);
  //stage.on('contentMousemove', function() {
  //  layer.batchDraw();
  //});
</script>
</body> </html>
